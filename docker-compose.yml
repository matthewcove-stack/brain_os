version: '3.9'
services:
  intent_postgres:
    image: postgres:16
    container_name: brainos_intent_postgres
    environment:
      POSTGRES_DB: intent
      POSTGRES_USER: intent
      POSTGRES_PASSWORD: intent
    volumes:
    - intent_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U intent -d intent
      interval: 3s
      timeout: 3s
      retries: 30
    networks:
      brain_os:
        aliases:
        - intent_postgres
  intent_migrate:
    build:
      context: ../intent_normaliser
    container_name: brainos_intent_migrate
    environment:
      DATABASE_URL: postgresql+psycopg://intent:intent@intent_postgres:5432/intent
    depends_on:
      intent_postgres:
        condition: service_healthy
    command:
    - alembic
    - upgrade
    - head
    networks:
    - brain_os
  intent_normaliser:
    build:
      context: ../intent_normaliser
    container_name: brainos_intent_normaliser
    environment:
      DATABASE_URL: postgresql+psycopg://intent:intent@intent_postgres:5432/intent
      INTENT_SERVICE_TOKEN: ${INTENT_SERVICE_TOKEN:-change-me}
      USER_TIMEZONE: Europe/London
      MIN_CONFIDENCE_TO_WRITE: '0.75'
      MAX_INFERRED_FIELDS: '2'
      EXECUTE_ACTIONS: ${EXECUTE_ACTIONS:-true}
      GATEWAY_BASE_URL: ${GATEWAY_BASE_URL:-http://notion_gateway:5678/webhook}
      GATEWAY_BEARER_TOKEN: ${GATEWAY_BEARER_TOKEN:-change_me_api_token}
      GATEWAY_TASKS_CREATE_PATH: ${GATEWAY_TASKS_CREATE_PATH:-/v1/notion/tasks/create}
      GATEWAY_TASKS_UPDATE_PATH: ${GATEWAY_TASKS_UPDATE_PATH:-/v1/notion/tasks/update}
      GATEWAY_LISTS_ADD_ITEM_PATH: ${GATEWAY_LISTS_ADD_ITEM_PATH:-/v1/notion/lists/add_item}
      GATEWAY_NOTES_CAPTURE_PATH: ${GATEWAY_NOTES_CAPTURE_PATH:-/v1/notion/notes/capture}
      GATEWAY_TIMEOUT_SECONDS: '15'
      CONTEXT_API_BASE_URL: ${CONTEXT_API_BASE_URL:-http://context_api:8001}
      CONTEXT_API_BEARER_TOKEN: ${CONTEXT_API_BEARER_TOKEN:-change-me}
      CONTEXT_API_RESEARCH_ENABLED: ${CONTEXT_API_RESEARCH_ENABLED:-false}
      CONTEXT_API_RESEARCH_TOPIC_KEY: ${CONTEXT_API_RESEARCH_TOPIC_KEY:-general}
      CONTEXT_API_RESEARCH_MAX_ITEMS: ${CONTEXT_API_RESEARCH_MAX_ITEMS:-3}
      CONTEXT_API_RESEARCH_RECENCY_DAYS: ${CONTEXT_API_RESEARCH_RECENCY_DAYS:-30}
      VERSION: 0.0.0
      GIT_SHA: unknown
      INTENT_CORS_ORIGINS: ${INTENT_CORS_ORIGINS:-http://localhost:8088,http://localhost:5173,https://voice.lambiclabs.com}
    ports:
    - 8000:8000
    depends_on:
      intent_postgres:
        condition: service_healthy
      intent_migrate:
        condition: service_completed_successfully
      notion_gateway:
        condition: service_started
      context_api:
        condition: service_started
    command:
    - uvicorn
    - app.main:app
    - --host
    - 0.0.0.0
    - --port
    - '8000'
    networks:
      brain_os:
        aliases:
        - intent_normaliser
  notion_postgres:
    image: postgres:15
    container_name: brainos_notion_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: n8n
      POSTGRES_PASSWORD: n8n
      POSTGRES_DB: n8n
    volumes:
    - notion_postgres_data:/var/lib/postgresql/data
    networks:
      brain_os:
        aliases:
        - notion_postgres
  notion_gateway:
    image: n8nio/n8n:1.66.0
    container_name: brainos_notion_gateway
    restart: unless-stopped
    depends_on:
    - notion_postgres
    ports:
    - 5678:5678
    env_file:
    - ../notion_gateway/.env
    environment:
      N8N_BASIC_AUTH_ACTIVE: 'true'
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: notion_postgres
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_USER: n8n
      DB_POSTGRESDB_PASSWORD: n8n
    volumes:
    - notion_n8n_data:/home/node/.n8n
    - ../notion_gateway/schemas:/files/schemas:ro
    networks:
      brain_os:
        aliases:
        - notion_gateway
  context_postgres:
    image: postgres:16
    container_name: brainos_context_postgres
    environment:
      POSTGRES_DB: context
      POSTGRES_USER: context
      POSTGRES_PASSWORD: context
    volumes:
    - context_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U context -d context
      interval: 3s
      timeout: 3s
      retries: 30
    networks:
      brain_os:
        aliases:
        - context_postgres
  context_migrate:
    build:
      context: ../context_api
    container_name: brainos_context_migrate
    environment:
      DATABASE_URL: postgresql+psycopg://context:context@context_postgres:5432/context
    depends_on:
      context_postgres:
        condition: service_healthy
    command:
    - alembic
    - upgrade
    - head
    networks:
    - brain_os
  context_api:
    build:
      context: ../context_api
    container_name: brainos_context_api
    environment:
      DATABASE_URL: postgresql+psycopg://context:context@context_postgres:5432/context
      CONTEXT_API_TOKEN: ${CONTEXT_API_BEARER_TOKEN:-change-me}
      VERSION: 0.0.0
      GIT_SHA: unknown
    depends_on:
      context_postgres:
        condition: service_healthy
      context_migrate:
        condition: service_completed_successfully
    command:
    - uvicorn
    - app.main:app
    - --host
    - 0.0.0.0
    - --port
    - '8001'
    networks:
      brain_os:
        aliases:
        - context_api
  context_research_worker:
    build:
      context: ../context_api
    container_name: brainos_context_research_worker
    environment:
      DATABASE_URL: postgresql+psycopg://context:context@context_postgres:5432/context
      CONTEXT_API_TOKEN: ${CONTEXT_API_BEARER_TOKEN:-change-me}
      RESEARCH_WORKER_ENABLED: ${RESEARCH_WORKER_ENABLED:-true}
      RESEARCH_SOURCE_FAILURE_THRESHOLD: ${RESEARCH_SOURCE_FAILURE_THRESHOLD:-3}
      RESEARCH_SOURCE_COOLDOWN_MINUTES: ${RESEARCH_SOURCE_COOLDOWN_MINUTES:-60}
      RESEARCH_RUN_MAX_NEW_ITEMS: ${RESEARCH_RUN_MAX_NEW_ITEMS:-0}
    depends_on:
      context_postgres:
        condition: service_healthy
      context_migrate:
        condition: service_completed_successfully
    command:
    - python
    - -m
    - app.research.worker
    - --sleep-seconds
    - '10'
    networks:
      brain_os:
        aliases:
        - context_research_worker
  voice_api:
    build:
      context: ../lambic_voice_client
      dockerfile: apps/api/Dockerfile
    container_name: brainos_voice_api
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY:-changeme}
      TRANSCRIBE_MODEL: ${TRANSCRIBE_MODEL:-gpt-4o-mini-transcribe}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      PORT: '8787'
      CORS_ORIGINS: ${VOICE_API_CORS_ORIGINS:-http://localhost:8088,http://localhost:5173}
      RATE_LIMIT_RPM: ${VOICE_API_RATE_LIMIT_RPM:-120}
    ports:
    - 8787:8787
    healthcheck:
      test:
      - CMD-SHELL
      - wget -qO- http://localhost:8787/healthz || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
    networks:
      brain_os:
        aliases:
        - voice_api
  voice_web:
    build:
      context: ../lambic_voice_client
      dockerfile: apps/web/Dockerfile
      args:
        VITE_NORMALISER_BASE_URL: ${VITE_NORMALISER_BASE_URL:-http://localhost:8000}
        VITE_NORMALISER_BEARER_TOKEN: ${VITE_NORMALISER_BEARER_TOKEN:-}
        VITE_TRANSCRIBE_BASE_URL: ${VITE_TRANSCRIBE_BASE_URL:-http://localhost:8787}
        VITE_PACKET_BASE_URL: ${VITE_PACKET_BASE_URL:-}
    container_name: brainos_voice_web
    depends_on:
      voice_api:
        condition: service_started
    healthcheck:
      test:
      - CMD-SHELL
      - wget -qO- http://localhost:8080/healthz || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
    networks:
      brain_os:
        aliases:
        - voice_web
volumes:
  intent_postgres_data: null
  notion_postgres_data: null
  notion_n8n_data: null
  context_postgres_data: null
networks:
  brain_os:
    name: brain_os_net
